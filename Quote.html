<script>
    // Ensure DOM is loaded before attaching event listeners
    document.addEventListener('DOMContentLoaded', function() {
        const addButton = document.getElementById('addInstrument');
        if (addButton) {
            addButton.addEventListener('click', function() {
                const items = document.getElementById('items');
                const itemRows = items.getElementsByClassName('item-row');
                const visibleItems = Array.from(itemRows).filter(row => !row.classList.contains('hidden')).length;
                const nextItem = visibleItems + 1;
                if (nextItem <= 5) {
                    const newItem = document.querySelector(`[data-item="${nextItem}"]`);
                    if (newItem) {
                        newItem.classList.remove('hidden');
                        newItem.querySelectorAll('input, textarea').forEach(input => {
                            input.value = '';
                        });
                        if (nextItem > 1) {
                            newItem.querySelector('.remove-button').classList.remove('hidden');
                        }
                    }
                } else {
                    alert('Maximum of 5 instruments reached.');
                }
            });
        }

        // Remove instrument row (only for rows after the first)
        document.querySelectorAll('.remove-button').forEach(button => {
            button.addEventListener('click', function() {
                const itemNum = parseInt(this.getAttribute('data-item'));
                if (itemNum > 1) {
                    const itemRow = document.querySelector(`[data-item="${itemNum}"]`);
                    if (itemRow) {
                        itemRow.classList.add('hidden');
                        itemRow.querySelectorAll('input, textarea').forEach(input => {
                            input.value = '';
                        });
                        const items = document.getElementById('items').getElementsByClassName('item-row');
                        Array.from(items).forEach((row, index) => {
                            if (!row.classList.contains('hidden') && index > 0) {
                                const newItemNum = index + 1;
                                row.setAttribute('data-item', newItemNum);
                                row.querySelector('label').textContent = `Instrument #${newItemNum}`;
                                row.querySelectorAll('input, textarea').forEach(input => {
                                    const name = input.name.replace(/\[\d+\]/, `[${newItemNum}]`);
                                    input.name = name;
                                });
                                row.querySelector('.remove-button').setAttribute('data-item', newItemNum);
                            }
                        });
                    }
                } else {
                    alert('The first instrument cannot be removed.');
                }
            });
        });

        // Form submission handling with Netlify integration
        document.getElementById('quoteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = this;
            const submitButton = form.querySelector('.submit-button');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';

            try {
                const formData = new FormData(form);
                const response = await fetch('/', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    alert('Thank you! Your quote request has been submitted. Weâ€™ll contact you within 24-48 hours.');
                    form.reset();
                    document.querySelectorAll('.item-row').forEach((row, index) => {
                        if (index > 0) row.classList.add('hidden');
                        const removeBtn = row.querySelector('.remove-button');
                        if (removeBtn) removeBtn.classList.add('hidden');
                    });
                } else {
                    alert('Submission failed. Please check your input and try again or email sales@fundamentalcalibrations.com.');
                }
            } catch (error) {
                alert('An error occurred: ' + error.message + '. Please try again or email sales@fundamentalcalibrations.com.');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Submit';
            }
        });
    });
</script>
